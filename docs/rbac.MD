# Custom Claims & Role-based Access Control (RBAC)

This is the custom setup code for Supabase to use JWTs with custom claims.

## Create the necessary tables
The important steps here are to define:
* Roles for your use cases
* Permissions for the roles

```
drop type public.app_permission;
drop type public.app_role;
-- Custom types
create type public.app_permission as enum ('dashboards.edit', 'dashboards.view');
create type public.app_role as enum ('developer', 'customer');

-- USER ROLES
create table public.user_roles (
  id        bigint generated by default as identity primary key,
  user_id   uuid references auth.users on delete cascade not null,
  role      app_role not null,
  unique (user_id, role)
);
comment on table public.user_roles is 'Application roles for each user.';

-- ROLE PERMISSIONS
create table public.role_permissions (
  id           bigint generated by default as identity primary key,
  role         app_role not null,
  permission   app_permission not null,
  unique (role, permission)
);
comment on table public.role_permissions is 'Application permissions for each role.';
```

## Assign permission to roles
```
insert into public.role_permissions (role, permission)
values
  ('developer', 'dashboards.view'),
  ('developer', 'dashboards.edit'),
  ('customer', 'dashboards.view');
```

## Assign users to roles
In the table **user_roles** you assign your existing users to the roles defined in the
previous steps.

## Create the hook
The following hook is executed every time a JWT is issued by Supabase and attaches
the roles and permissions als claims to the JWT.

This hook is generic and does not need any customization.
```
-- Create the auth hook function
create or replace function public.custom_access_token_hook(event jsonb)
returns jsonb
language plpgsql
stable
as $$
  declare
    claims jsonb;
    user_role public.app_role;
  begin
    -- Fetch the user role in the user_roles table
    select role into user_role from public.user_roles where user_id = (event->>'user_id')::uuid;

    claims := event->'claims';

    if user_role is not null then
      -- Set the claim
      claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
    else
      claims := jsonb_set(claims, '{user_role}', 'null');
    end if;

    -- Update the 'claims' object in the original event
    event := jsonb_set(event, '{claims}', claims);

    -- Return the modified or original event
    return event;
  end;
$$;

grant usage on schema public to supabase_auth_admin;

grant execute
  on function public.custom_access_token_hook
  to supabase_auth_admin;

revoke execute
  on function public.custom_access_token_hook
  from authenticated, anon, public;

grant all
  on table public.user_roles
to supabase_auth_admin;

revoke all
  on table public.user_roles
  from authenticated, anon, public;
```

## Activation of the hook
The last step is to manually enable the hook inside the Authentication menu.

For more (and the latest information) please refer to
[Supabase Doc](https://supabase.com/docs/guides/database/postgres/custom-claims-and-role-based-access-control-rbac)